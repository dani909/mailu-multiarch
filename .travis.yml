language: minimal
dist: xenial

services:
  - docker

env:
  global:
    - TRAVIS=true
    - secure: "IWyGS7ywdP0qFlTHDJsz/3M0H6U4Rxbjbxm2ghSy3ER8q20wP3BARWUZ2BmYvZvXr49T7/KruRz3gES8sHyioGVUozrBjTrxepuDLiJh5IWpj6fuzRF40iE9iW37Iu8W2YeZrDourGh1o0anSqshGrIQgTqwqT8RVacCzNeIuaK+yFAzg8jVxUF0buqVPzQbpAVv+8DWCgZxfaKfFunw4uIU9jibXdlHCSe6rpMrZ2tvCc2y2ZWItUlDguH/WpgIJflhdvZ7NywyYhfwusSYTNGfqsq6nB3unzklQCAQbrp6zxLfF8lPvhcXxCevIMo7cP15Ox9tIiKt4jaPWTwhd0Eo5UvSlSolUfzfYqew7rS/7uxe++yN6OWMX488GKmb9g8oq5ASco6oLX9fxPxvAD2jK4IEEKBEeD97wUD1l+4mFKdWH5HwRUh+dopR0XhjkTJsz3P3i0Nn2nadUjyMefoWcfZP5ULFT+XilS4TIrWuRRoHcCEh0btTeh/61Bj/lhYbl4jHH6LKvYWzi/oag0BtJFakJgF4/7LcLmrt8vd3XUf9HuJlrYpzPSkE+7RR82dhqwph0jsIU4e1F/HxnQJn0aRecvmDIPkTj7h0ZnpTV2cXd+7pMU8OLsYMcoSh/Z4m5sFbSwd6M4ALgGmOiIHuDlR4lnu72c+vArWGCuM="
  matrix:
    - IMAGE=core/admin
    - IMAGE=core/dovecot
    - IMAGE=core/nginx
    - IMAGE=core/none
    - IMAGE=core/postfix
    - IMAGE=optional/clamav
    - IMAGE=optional/postgresql
    - IMAGE=optional/radicale
    - IMAGE=optional/traefik-certdumper
    - IMAGE=services/fetchmail
    - IMAGE=services/rspamd
    - IMAGE=services/unbound
    - IMAGE=webmails/rainloop
    - IMAGE=webmails/roundcube

before_install:
- sudo bash scripts/setup-binfmt.sh
- bash scripts/cron-cache.sh
- mkdir ~/.local/share/img || true
- sudo chmod -R 777 ~/.local/share/img
- sudo chown -R root:root ~/.local/share/img

script:
- bash build.sh

deploy:
  provider: script
  script: bash push.sh
  on:
    branch: master
